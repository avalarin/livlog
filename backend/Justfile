# Livlog Backend Justfile
# Run commands from the backend/ directory

# Default recipe
default:
    @just --list

# Build the server binary
build:
    go build -o bin/server ./cmd/server

# Run tests
test:
    go test -v -race ./...

# Run tests with coverage
test-coverage:
    go test -v -race -coverprofile=coverage.out ./...
    go tool cover -html=coverage.out -o coverage.html

# Run linter
lint:
    golangci-lint run ./...

# Run the server locally
run:
    go run ./cmd/server -config config.yaml -migrations migrations

# Format code
fmt:
    gofmt -w .
    goimports -w -local github.com/avalarin/livlog/backend .

# Download dependencies
deps:
    go mod download
    go mod tidy

# Build Docker image
docker-build:
    docker build -t livlog-backend:latest .

# Start services with docker-compose
docker-up:
    docker compose up -d --build

# Stop services with docker-compose
docker-down:
    docker compose down

# View docker-compose logs
docker-logs:
    docker compose logs -f

# Run database migrations up
migrate-up:
    go run -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest \
        -path migrations \
        -database "postgres://livlog:livlog@localhost:5432/livlog?sslmode=disable" \
        up

# Run database migrations down
migrate-down:
    go run -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest \
        -path migrations \
        -database "postgres://livlog:livlog@localhost:5432/livlog?sslmode=disable" \
        down 1

# Create a new migration
migrate-create name:
    go run -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest \
        create -ext sql -dir migrations -seq {{name}}

# Clean build artifacts
clean:
    rm -rf bin/
    rm -f coverage.out coverage.html

# Generate RSA keys for JWT signing (development only)
generate-keys:
    mkdir -p keys
    openssl genrsa -out keys/private_key.pem 2048
    openssl rsa -in keys/private_key.pem -pubout -out keys/public_key.pem
    chmod 600 keys/private_key.pem
    @echo "✓ RSA keys generated in keys/ directory"

# Setup auth (generate keys and run auth migrations)
setup-auth: generate-keys
    @echo "✓ Auth setup complete"
